<!DOCTYPE html>
<html lang="en" data-video-id="jfKfPfyJRdk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Athletic Spirit ‚Äî AI Coach</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Teko:wght@600;700&display=swap" rel="stylesheet">
  <style>
    /* -------------------------
       RESET & THEME
    -------------------------- */
    *,*::before,*::after{box-sizing:border-box}
    html,body{margin:0;padding:0}
    :root{
      --bg:#0a1a23;
      --ink:#ffffff;
      --muted:#c5e0ec;
      --primary:#00ff9d;     /* neon green */
      --accent:#00e5ff;      /* electric blue */
      --card:rgba(8,26,35,.55);
      --glass:blur(10px) saturate(120%);
      --ring:0 0 0 1px rgba(0,255,157,.35), 0 15px 35px rgba(0,255,157,.15);
      --ring-blue:0 0 0 1px rgba(0,229,255,.3), 0 15px 35px rgba(0,229,255,.12);
      --radius:18px;
      --speed:220ms;
      --font-heading: 'Teko', sans-serif;
      --font-body: 'Inter', sans-serif;
      --text-shadow: 0 1px 4px rgba(0,0,0,.5);
    }
    body{
      font-family: var(--font-body);
      color:var(--ink);
      line-height:1.5;
      overflow-x:hidden;
    }
    /* -------------------------
       NAVBAR
    -------------------------- */
    .nav{
      position:fixed; inset-inline:0; top:0; z-index:20;
      display:flex; align-items:center; justify-content:space-between;
      padding:14px 24px; backdrop-filter: var(--glass);
      background:linear-gradient(180deg, rgba(3,12,18,.75), rgba(3,12,18,.35) 70%, transparent);
      border-bottom:1px solid rgba(0,229,255,.15);
    }
    .brand{
      display:flex; align-items:center; gap:.6rem;
      font-family: var(--font-heading); font-weight:700; font-size:1.2rem; letter-spacing:1px;
    }
    .brand .dot{width:10px; height:10px; border-radius:50%; background:var(--primary); box-shadow:0 0 12px var(--primary)}
    .nav a{color:var(--ink); text-decoration:none; margin:0 .75rem; opacity:.9; font-weight:700;}
    .nav a:hover{color:var(--primary)}
    .cta{
      background: linear-gradient(90deg, var(--primary), var(--accent));
      color:#06161d; border:none; border-radius:999px; padding:.65rem 1rem; cursor:pointer;
      font-family: var(--font-heading);
      font-weight:700; font-size:1rem; letter-spacing:.5px;
      box-shadow: var(--ring); transition: transform var(--speed) ease;
    }
    .cta:hover{ transform: translateY(-1px) scale(1.02); }

    /* -------------------------
       HERO with YOUTUBE BG
    -------------------------- */
    .hero{
      position:relative; height:100svh; display:grid; place-items:center; text-align:center; overflow:hidden;
    }
    .yt-wrap{
      position:fixed; inset:0; z-index:-1; pointer-events:none; overflow:hidden;
    }
    .yt-wrap iframe{
      /* This ensures the video covers the area, maintaining its 16:9 aspect ratio */
      position: absolute;
      top: 50%;
      left: 50%;
      width: 100vw;
      height: 56.25vw; /* 16:9 Aspect Ratio (9 / 16 = 0.5625) */
      min-height: 100vh;
      min-width: 177.77vh; /* 16:9 Aspect Ratio (16 / 9 = 1.7777) */
      transform: translate(-50%, -50%);
      pointer-events: none;
    }
    .hero::after{
      content:''; position:absolute; inset:0;
      background: radial-gradient(1200px 600px at 80% 20%, rgba(0,229,255,.25), transparent 55%),
                  radial-gradient(1000px 600px at 20% 80%, rgba(0,255,157,.25), transparent 55%),
                  rgba(4,16,22,.55);
      backdrop-filter: blur(2px);
      z-index:1;
    }
    .hero-content{
      position:relative; z-index:2; padding:1rem 2rem; max-width:900px;
      animation: fadeUp .9s ease both;
    }
    .kicker{
      color:var(--primary); text-transform:uppercase; letter-spacing:2px; font-size:.9rem;
      font-family: var(--font-heading); font-weight:700;
    }
    .title{
      font-family: var(--font-heading); font-weight:700; text-transform:uppercase;
      font-size: clamp(2.8rem, 6vw, 4.5rem); line-height:1; margin:.6rem 0 1rem;
      text-shadow: var(--text-shadow), 0 0 24px rgba(0,255,157,.25);
    }
    .sub{color:var(--muted); max-width:62ch; margin-inline:auto; text-shadow: var(--text-shadow);}
    .hero-actions{margin-top:1.25rem; display:flex; gap:.8rem; justify-content:center; flex-wrap:wrap}
    .btn{
      border:none; padding:.85rem 1.1rem; border-radius:12px; cursor:pointer;
      font-family: var(--font-heading); font-weight:700; font-size:1rem; letter-spacing:.5px;
      transition: transform var(--speed) ease, box-shadow var(--speed) ease;
    }
    .btn-primary{ background:linear-gradient(90deg,var(--primary), var(--accent)); color:#041216; box-shadow: var(--ring);}
    .btn-ghost{ background:rgba(255,255,255,.08); color:var(--ink); border:1px solid rgba(255,255,255,.12); box-shadow: var(--ring-blue);}
    .btn:hover{ transform: translateY(-2px); }

    @keyframes fadeUp{from{opacity:0; transform:translateY(18px)} to{opacity:1; transform:translateY(0)}}

    /* -------------------------
       FEATURE STRIP
    -------------------------- */
    .features{
      position:relative; z-index:3; margin:-60px auto 0; padding:0 18px; max-width:1200px;
      display:grid; grid-template-columns:repeat(3,1fr); gap:16px;
    }
    .feature{
      background:var(--card); border:1px solid rgba(0,229,255,.15); border-radius:var(--radius);
      backdrop-filter: var(--glass); padding:18px; box-shadow: var(--ring-blue);
      transition:transform var(--speed) ease, box-shadow var(--speed) ease;
    }
    .feature:hover{ transform:translateY(-4px); box-shadow: 0 0 0 1px rgba(0,255,157,.35), 0 30px 45px rgba(0,255,157,.12);}
    .feature h3{
      font-family: var(--font-heading); font-weight:700; font-size:1.5rem; letter-spacing:.5px;
      margin:.4rem 0 .25rem;
    }
    .feature .sub { text-shadow: var(--text-shadow); }
    .chip{
      display:inline-block; padding:.25rem .5rem; border-radius:999px; background:rgba(0,255,157,.12); border:1px solid rgba(0,255,157,.35); color:var(--primary); font-size:.78rem; letter-spacing:.3px;
      font-family: var(--font-heading); font-weight:700;
    }

    /* -------------------------
       RECOMMENDATIONS
    -------------------------- */
    main {
      position: relative;
      background: transparent;
    }
    section{padding:72px 18px}
    .section-wrap{max-width:1200px; margin:0 auto}
    .section-title{
      font-family: var(--font-heading); font-weight:700; text-transform:uppercase; letter-spacing:1px;
      font-size: clamp(1.8rem, 4vw, 2.5rem); margin-bottom:14px;
      text-shadow: var(--text-shadow);
    }
    .section-sub{color:var(--muted); margin-bottom:18px; text-shadow: var(--text-shadow);}
    .recs{
      display:grid; grid-auto-flow:column; grid-auto-columns: minmax(260px, 1fr); gap:16px; overflow-x:auto; scroll-snap-type:x mandatory; padding-bottom:6px;
    }
    .card{
      scroll-snap-align:start;
      background:linear-gradient(180deg, rgba(0,229,255,.08), rgba(0,255,157,.08));
      border:1px solid rgba(255,255,255,.14); border-radius:16px; padding:16px;
      min-height:170px; display:flex; flex-direction:column; justify-content:space-between;
      box-shadow: var(--ring-blue); transition: transform var(--speed) ease;
    }
    .card:hover{ transform: translateY(-4px) }
    .tag{font-size:.8rem; opacity:.85; color:var(--primary); font-family:var(--font-heading); font-weight:700;}
    .card h4{
      font-family: var(--font-heading); font-weight:600; font-size:1.3rem; letter-spacing:.5px;
      margin:.25rem 0 .35rem;
    }
    .meta{display:flex; gap:10px; font-size:.82rem; color:var(--muted)}
    .card button{
      align-self:flex-start; margin-top:.4rem; border:none; border-radius:10px; padding:.55rem .8rem;
      background:rgba(255,255,255,.1); color:var(--ink); border:1px solid rgba(255,255,255,.18); cursor:pointer;
    }
    .card button:hover{ background:rgba(255,255,255,.18) }

    /* -------------------------
       GALLERY / TESTIMONIALS (quick)
    -------------------------- */
    .grid{
      display:grid; grid-template-columns:repeat(auto-fit, minmax(300px, 1fr)); gap:16px;
    }
    .tile{
      position: relative;
      border-radius:16px;
      min-height:280px;
      overflow: hidden;
      border:1px solid rgba(255,255,255,.12);
      box-shadow: var(--ring-blue);
      transition: transform var(--speed) ease;
    }
    .tile:hover { transform: scale(1.03); }
    .tile img {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      z-index: 1;
      transition: transform calc(var(--speed) * 2) ease;
    }
    .tile:hover img { transform: scale(1.1); }
    .tile-overlay {
      position: absolute;
      inset: 0;
      z-index: 2;
      background: linear-gradient(to top, rgba(4,16,22,.9) 10%, rgba(4,16,22,.5) 50%, transparent 80%);
    }
    .tile-content {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 3;
      padding: 16px;
      color: var(--ink);
    }
    .tile-content h4 { font-family: var(--font-heading); font-weight: 700; font-size: 1.3rem; margin: 0 0 4px; text-shadow: var(--text-shadow); }
    .tile-content p {
      font-size: .9rem; color: var(--muted); margin: 0;
      font-style: italic;
    }

    /* -------------------------
       CHATBOT FLOATING
    -------------------------- */
    .chat{
      /* From popup to embedded feature */
      display: flex;
      flex-direction: column;
      height: 520px; /* Fixed height for scrollable body */
      background: var(--card);
      border: 1px solid rgba(0,229,255,.15);
      border-radius: var(--radius);
      box-shadow: var(--ring-blue);
      overflow: hidden;
    }

    .chat .body{flex:1; padding:12px; overflow-y:auto; display:flex; flex-direction:column; gap:10px}
    .msg{max-width:80%; padding:10px 12px; border-radius:14px; font-size:.95rem}
    .bot{ align-self:flex-start; background:rgba(0,229,255,.14); border:1px solid rgba(0,229,255,.35)}
    .you{ align-self:flex-end; background:rgba(0,255,157,.14); border:1px solid rgba(0,255,157,.35)}

    .quick{
      display:flex; gap:8px; flex-wrap:wrap; padding:12px 12px 0;
      border-top:1px solid rgba(255,255,255,.12);
    }
    .quick button{
      border:none; padding:.4rem .6rem; border-radius:999px; font-size:.8rem;
      background:rgba(255,255,255,.08); color:var(--ink); border:1px solid rgba(255,255,255,.15); cursor:pointer;
    }
    .quick button:hover{ background:rgba(255,255,255,.14) }
    .chat .foot{display:flex; gap:8px; padding:10px 12px 12px;}
    .chat input{flex:1; padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.18); background:rgba(255,255,255,.06); color:var(--ink); outline:none}
    .chat button.send{
      border:none; border-radius:10px; padding:.6rem .9rem; background:linear-gradient(90deg, var(--primary), var(--accent)); color:#031a21; font-weight:800;
      cursor: pointer;
      transition: opacity var(--speed) ease;
    }
    .chat button.send:hover:not(:disabled) { opacity: .9; }
    .chat button.send:disabled { opacity: .5; cursor: not-allowed; }

    /* Typing indicator for bot "thinking" state */
    .typing-indicator { display: flex; align-items: center; gap: 4px; padding: 8px 0; }
    .typing-indicator span {
      width: 8px; height: 8px; border-radius: 50%; background-color: rgba(0,229,255,.6);
      animation: bounce 1.2s infinite ease-in-out;
    }
    .typing-indicator span:nth-child(2) { animation-delay: -0.2s; }
    .typing-indicator span:nth-child(3) { animation-delay: -0.4s; }
    @keyframes bounce {
      0%, 80%, 100% { transform: scale(0); }
      40% { transform: scale(1.0); }
    }

    /* -------------------------
       FOOTER
    -------------------------- */
    footer{
      position: relative;
      background: var(--bg);
      padding:36px 18px; border-top:1px solid rgba(255,255,255,.08);
      color:var(--muted); text-align:center
    }

    /* -------------------------
       AI COACH SECTION
    -------------------------- */
    #ai-coach {
      background: radial-gradient(1200px 500px at 50% 0%, rgba(0,255,157,.1), transparent 70%);
    }

    /* -------------------------
       RESPONSIVE
    -------------------------- */
    @media (max-width: 900px){
      .features{grid-template-columns:1fr; margin-top:-40px}
      .grid{grid-template-columns:1fr}
    }
  </style>
</head>
<body>

  <!-- YouTube background -->
  <div class="yt-wrap">
    <iframe id="ytbg" src=""
      title="Sports background" frameborder="0"
      allow="autoplay; encrypted-media" allowfullscreen></iframe>
  </div>

  <!-- NAV -->
  <nav class="nav">
    <div class="brand"><span class="dot"></span> Athletic Spirit</div>
    <div>
      <a href="#features">Features</a>
      <a href="dashboard.html" id="dashboard-link" style="display: none;">Dashboard</a>
      <a href="#clubs">Clubs</a>
      <a href="#gallery">Gallery</a>
      <a href="#contact">Contact</a>
    </div>
    <button class="cta" onclick="document.querySelector('#ai-coach').scrollIntoView({behavior:'smooth'})">Chat with Coach</button>
    <button class="cta" id="nav-cta" onclick="window.location.href='login.html'">Login</button>
  </nav>

  <!-- HERO with YouTube background -->
  <header class="hero" id="home">
    <div class="hero-content">
      <div class="kicker">Train smarter</div>
      <h1 class="title">Push Your Limits. Recover Better. Perform Consistently.</h1>
      <p class="sub">A performance hub for athletes and coaches ‚Äî live recommendations for events & run clubs, a simple planner, and a smart chatbot that knows your training goals.</p>
      <div class="hero-actions">
        <button class="btn btn-primary" onclick="document.querySelector('#features').scrollIntoView({behavior:'smooth'})">Explore Features</button>
        <button class="btn btn-ghost" onclick="document.querySelector('#ai-coach').scrollIntoView({behavior:'smooth'})">Ask the Coach</button>
      </div>
    </div>
  </header>

  <main>
    <!-- FEATURE STRIP -->
    <div class="features" id="features">
      <a href="dashboard.html" style="text-decoration: none; color: inherit;">
        <div class="feature">
          <span class="chip">Dashboard</span>
          <h3>Readiness ¬∑ Load ¬∑ Recovery</h3>
          <p class="sub">See weekly load, sleep, HR trends and smart flags. Lightweight tiles ‚Äî fast and focused.</p>
        </div>
      </a>
      <div class="feature">
        <span class="chip">Clubs & Events</span>
        <h3>Find Run Clubs ¬∑ RSVP ¬∑ Join</h3>
        <p class="sub">Hyperlocal meetups, weekend long runs, races and scrimmages ‚Äî surfaced just for you.</p>
      </div>
      <div class="feature">
        <span class="chip">Planner</span>
        <h3>Plan vs Done</h3>
        <p class="sub">Drag sessions, mark complete, auto-tune next week. Constraints keep you injury-safe.</p>
      </div>
    </div>

    <!-- AI COACH CHAT -->
    <section id="ai-coach">
      <div class="section-wrap">
        <h2 class="section-title">Your AI Coach is Ready</h2>
        <p class="section-sub">Ask anything ‚Äî from finding a local run club to planning your next training block.</p>
        <div class="chat" id="chat">
          <div class="body" id="msgs">
            <div class="msg bot">Hey! üëã I'm your AI Coach. How can I help you train smarter today?</div>
          </div>
          <div class="quick" id="quick">
            <button onclick="sendPrompt('Recommend clubs')">Recommend clubs</button>
            <button onclick="sendPrompt('Events this weekend')">Events this weekend</button>
            <button onclick="sendPrompt('Log run 5k easy')">Log 5k easy</button>
            <button onclick="sendPrompt('Plan intervals')">Plan intervals</button>
          </div>
          <div class="foot">
            <input id="input" placeholder="Ask your AI coach..." />
            <button class="send" onclick="send()">Send</button>
          </div>
        </div>
      </div>
    </section>

    <!-- RECOMMENDATIONS -->
    <section id="clubs">
      <div class="section-wrap">
        <h2 class="section-title">üî• Recommended Events & Run Clubs</h2>
        <p class="section-sub">Based on your interests and preferred times.</p>
        <div class="recs" id="recStrip"><!-- cards injected --></div>
      </div>
    </section>

    <!-- GALLERY / TESTIMONIALS LOOK -->
    <section id="gallery">
      <div class="section-wrap">
        <h2 class="section-title">Moments that Matter</h2>
        <p class="section-sub">Snaps from the community ‚Äî early miles, late grit.</p>
        <div class="grid">
          <!-- Tile 1: Community Photo -->
          <div class="tile">
            <img src="https://images.unsplash.com/photo-1571019613454-1cb2f99b2d8b?q=80&w=2070&auto=format&fit=crop" alt="Athlete running at sunrise">
            <div class="tile-overlay"></div>
            <div class="tile-content">
              <h4>Sunrise Run with the Crew</h4>
              <p>"Nothing beats the energy of a morning run club."</p>
            </div>
          </div>
          <!-- Tile 2: Feature Screenshot (Planner) -->
          <div class="tile">
            <img src="C:\Users\vigne\OneDrive\Desktop\Young Man City Reaching His Goals Stock Photo 1784812541 _ Shutterstock_files\7.jpg" alt="Screenshot of a training plan on a phone">
            <div class="tile-overlay"></div>
            <div class="tile-content">
              <h4>Plan vs. Done</h4>
              <p>"The AI Planner kept me on track for my first 10k."</p>
            </div>
          </div>
          <!-- Tile 3: Testimonial -->
          <div class="tile">
            <img src="https://images.unsplash.com/photo-1541534741688-6078c6bfb5c5?q=80&w=2069&auto=format&fit=crop" alt="Athlete celebrating after a workout">
            <div class="tile-overlay"></div>
            <div class="tile-content">
              <h4>New Personal Best!</h4>
              <p>"The AI Coach's interval suggestions were a game-changer."</p>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- FOOTER -->
  <footer id="contact">
    ¬© <span id="y"></span> Athletic Spirit. Built with care. | athleticspirit@gmail.com

  </footer>

  <!-- YouTube IFrame Player API Script -->
  <script src="https://www.youtube.com/iframe_api"></script>

  <script>
    // Footer year
    document.getElementById('y').textContent = new Date().getFullYear();

    // --------------------------
    // SIMPLE RECOMMENDER ENGINE
    // --------------------------
    // Initial static catalog (can be replaced or augmented by dynamic data)
    let catalog = [
      { id:1, type:'club', title:'Morning Run Crew', where:'Cubbon Park', when:'Sun 6:00 AM', tags:['running','endurance','social'], score:0 },
      { id:2, type:'event', title:'City 10K', where:'MG Road', when:'Sat 7:00 AM', tags:['race','road','10k'], score:0 },
      { id:3, type:'club', title:'Interval Tuesdays', where:'Kanteerava Track', when:'Tue 6:30 PM', tags:['speed','intervals'], score:0 },
      { id:4, type:'event', title:'Trail Half Marathon', where:'Nandi Hills', when:'Next Sun 5:30 AM', tags:['trail','half','endurance'], score:0 },
      { id:5, type:'club', title:'Weekend Football Crew', where:'Sports Arena', when:'Sat 6:00 PM', tags:['football','team'], score:0 },
      { id:6, type:'event', title:'Cycling Century', where:'Airport Loop', when:'Sun 5:30 AM', tags:['cycling','endurance'], score:0 },
    ];
    
    // User preferences will be loaded from the backend.
    // Initialize with defaults, then fetch.
    let prefs = { interests: new Set(['running']), time: 'morning' };
    let userRsvps = new Set(); // To store user's RSVPs

    // --- NEW: Function to fetch user data from backend ---
    async function loadUserData() {
      const token = localStorage.getItem('authToken');
      if (!token) {
        // The line below redirects to the login page if you are not authenticated.
        // For development, you can comment it out to view the page directly.
        // window.location.href = 'login.html'; // Redirect to login if not authenticated
        console.log("No auth token found. Using default preferences.");
        // Show Login button, hide Dashboard link
        document.getElementById('nav-cta').style.display = 'block';
        document.getElementById('dashboard-link').style.display = 'none';
        return;
      }

      try {
        const prefsResponse = await fetch('http://localhost:3000/api/preferences', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!prefsResponse.ok) {
          console.error("Failed to load preferences:", prefsResponse.statusText);
          return;
        }
        const userPrefs = await prefsResponse.json();
        prefs.interests = new Set(userPrefs.interests && userPrefs.interests.length ? userPrefs.interests : ['running']);
        prefs.time = userPrefs.time || 'morning';
        if (userPrefs.rsvps && Array.isArray(userPrefs.rsvps)) {
          userRsvps = new Set(userPrefs.rsvps);
        }

        // User is logged in: show Dashboard link, hide Login button
        document.getElementById('nav-cta').style.display = 'none';
        document.getElementById('dashboard-link').style.display = 'inline-block';

      } catch (err) {
        console.error("Error loading user data:", err);
      }
    }
    loadUserData().then(() => {
      // After loading user data, fetch events from Playo-like source and render recommendations
      fetchEventsFromPlayo();
      renderRecommendations();
    });

    function scoreItem(item){
      let s = 0;
      item.tags.forEach(t => { if (prefs.interests.has(t)) s += 3; });
      if (prefs.time === 'morning' && /AM|Sun|Sat/.test(item.when)) s += 2;
      if (prefs.time === 'evening' && /PM/.test(item.when)) s += 2;
      // Lightweight popularity bump for events
      if (item.type === 'event') s += 1;
      return s;
    }

    // Simulate fetching events from a "Playo-like" source
    // In a real application, this would involve an API call to a backend
    // that integrates with Playo or a similar event platform to get live data.
    function fetchEventsFromPlayo() {
      const newEventsFromPlayo = [
        { id:7, type:'event', title:'Badminton Tournament', where:'City Sports Complex', when:'Sat 2:00 PM', tags:['badminton','tournament','indoor'], score:0 },
        { id:8, type:'club', title:'Evening Cycling Group', where:'Lalbagh Road', when:'Wed 6:00 PM', tags:['cycling','social','road'], score:0 },
        { id:9, type:'event', title:'Yoga & Meditation Retreat', where:'Botanical Garden', when:'Next Sat 8:00 AM', tags:['yoga','wellness','outdoor'], score:0 },
        { id:10, type:'club', title:'Basketball Pickup Game', where:'Local Court', when:'Fri 7:00 PM', tags:['basketball','team','casual'], score:0 },
        { id:101, type:'event', title:'Community Fun Run', where:'Local Park', when:'Sun 9:00 AM', tags:['running','social','5k'], score:0 },
        { id:102, type:'club', title:'Morning Swimmers Club', where:'Aquatic Center', when:'Mon-Fri 6:00 AM', tags:['swimming','endurance'], score:0 },
        { id:103, type:'event', title:'Mountain Biking Challenge', where:'Hills Trails', when:'Next Sat 7:00 AM', tags:['cycling','mountain','endurance'], score:0 },
        { id:11, type:'event', title:'Table Tennis Open', where:'Community Hall', when:'Sun 10:00 AM', tags:['table tennis','tournament'], score:0 },
        { id:12, type:'club', title:'Early Bird Swimmers', where:'Olympic Pool', when:'Mon-Fri 5:30 AM', tags:['swimming','endurance'], score:0 },
      ];
      // Merge new events, avoiding duplicates by ID (simple merge for demo)
      const existingIds = new Set(catalog.map(e => e.id));
      newEventsFromPlayo.forEach(newEvent => {
        if (!existingIds.has(newEvent.id)) {
          catalog.push(newEvent);
        }
      });
      console.log("Events updated from Playo-like source:", catalog);
    }

    /**
     * Uses the Gemini API to rank the entire catalog based on user preferences.
     * @returns {Promise<Array>} A promise that resolves to the AI-ranked catalog.
     */
    async function getAiRankedCatalog() {
      // Prepare a specific prompt for the ranking task
      const rankingPrompt = `
        You are an expert recommendation engine. Your task is to rank a list of sporting events and clubs based on a user's profile.
        Analyze the user's profile and the catalog of items.
        Return a JSON array containing only the integer 'id' of each item, sorted from most to least relevant for the user.

        **User Profile:**
        - Interests: ${Array.from(prefs.interests).join(', ')}
        - Preferred Time: ${prefs.time}

        **Catalog of Items (JSON):**
        ${JSON.stringify(catalog.map(({id, type, title, tags, when}) => ({id, type, title, tags, when})))}

        **Your Response MUST be a valid JSON array of numbers, like this: [4, 1, 2, 6, 3, 5, ...]. Do not include any other text or markdown.**
      `;

      try {
        const response = await fetch(GEMINI_API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ contents: [{ parts: [{ text: rankingPrompt }] }] }),
        });
        if (!response.ok) throw new Error('AI ranking request failed');

        const data = await response.json();
        const textResponse = data.candidates[0].content.parts[0].text;
        const sortedIds = JSON.parse(textResponse.replace(/```json|```/g, '').trim());

        // Create a map for quick lookups and return the sorted catalog
        const catalogMap = new Map(catalog.map(item => [item.id, item]));
        return sortedIds.map(id => catalogMap.get(id)).filter(Boolean); // filter(Boolean) removes any undefined items
      } catch (error) {
        console.error("AI Ranking Error:", error, "Falling back to basic scoring.");
        // Fallback to the old scoring method if the API fails
        return catalog.map(it => ({...it, score:scoreItem(it)})).sort((a,b)=>b.score-a.score);
      }
    }

    async function renderRecs(){
      const strip = document.getElementById('recStrip');
      strip.innerHTML = '';
      
      // Get the AI-ranked list (or fallback to old method if it fails)
      const ranked = await getAiRankedCatalog();

      ranked.forEach(it=>{
        const el = document.createElement('div');
        el.className = 'card';
        el.innerHTML = `
          <div>
            <div class="tag">${it.type.toUpperCase()}</div>
            <h4>${it.title}</h4>
            <div class="meta"><span>${it.where}</span> ‚Ä¢ <span>${it.when}</span></div>
          </div>
          <button onclick="rsvp(${it.id})">RSVP</button>
        `;
        strip.appendChild(el);
        // Optionally, disable RSVP button if already RSVP'd
        if (userRsvps.has(it.id)) {
            el.querySelector('button').disabled = true;
            el.querySelector('button').textContent = 'RSVP\'d';
        }
      });
    }
    
    // --- UPDATED: Initial Load Sequence ---
    async function initializeApp() {
      await loadUserData(); // Load user prefs first
      fetchEventsFromPlayo(); // Then get event data
      renderRecs(); // Then render based on combined data
    }
    initializeApp();

    async function rsvp(id){
      const item = catalog.find(x=>x.id===id);
      const token = localStorage.getItem('authToken');
      // Persist RSVP to backend
      await fetch('http://localhost:3000/api/rsvp', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
        body: JSON.stringify({ eventId: id })
      });
      userRsvps.add(id); // Add to local set
      // Confirm to user
      pushBot(`‚úÖ Saved your RSVP for <b>${item.title}</b> at <i>${item.where}</i>. I‚Äôll remind you the day before.`);
    }

    // Simulate real-time updates by fetching and rendering events periodically
    setInterval(() => { fetchEventsFromPlayo(); renderRecs(); }, 15000); // Update every 15 seconds

    // --------------------------
    // CHATBOT (Gemini API Integration)
    // --------------------------
    const chat = document.getElementById('chat');
    const msgs = document.getElementById('msgs');
    const input = document.getElementById('input');

    // --- Backend Integration ---
    const BACKEND_URL = 'http://127.0.0.1:8000/chat';

    async function getBackendResponse(prompt) {
      try {
        const response = await fetch(BACKEND_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            user_input: prompt,
            user_id: 'default'  // Can be updated to use actual user ID if available
          }),
        });

        if (!response.ok) {
          throw new Error(`Backend request failed with status ${response.status}`);
        }

        const data = await response.json();
        return data.response;
      } catch (error) {
        console.error('Error calling backend:', error);
        
        // Check if it's a connection error
        if (error.message.includes('Failed to fetch') || error.name === 'TypeError') {
          return "‚ö†Ô∏è I'm unable to connect to the backend server. Please make sure the backend is running on http://127.0.0.1:8000. See the README.md for setup instructions.";
        }
        
        return "Sorry, I'm having trouble processing your request right now. Please try again in a moment.";
      }
    }

    function pushYou(text){ const b=document.createElement('div'); b.className='msg you'; b.innerHTML=text; msgs.appendChild(b); msgs.scrollTop=msgs.scrollHeight; }
    function pushBot(text){ const b=document.createElement('div'); b.className='msg bot'; b.innerHTML=text; msgs.appendChild(b); msgs.scrollTop=msgs.scrollHeight; }

    function sendPrompt(text){ input.value = text; send(); }

    async function send(){
      const t = (input.value||'').trim();
      const sendBtn = input.nextElementSibling;
      if(!t || sendBtn.disabled) return;

      pushYou(t);
      input.value='';
      input.disabled = true; // Disable input while waiting
      sendBtn.disabled = true;
      // Show a thinking indicator
      const thinkingMsg = document.createElement('div');
      thinkingMsg.className = 'msg bot';
      thinkingMsg.innerHTML = `<div class="typing-indicator"><span></span><span></span><span></span></div>`;
      msgs.appendChild(thinkingMsg);
      msgs.scrollTop = msgs.scrollHeight;

      // Flag to track if preferences were changed by the AI's response
      let preferencesChanged = false;

      const responseText = await getBackendResponse(t);
      thinkingMsg.innerHTML = responseText; // Update the thinking message with the actual response
      msgs.scrollTop = msgs.scrollHeight;

      // --- NEW: Check if the AI response is from the LoggerExpert ---
      if (responseText.includes("‚úîÔ∏è")) {
        // Attempt to parse distance from the original prompt 't'
        const distanceMatch = t.match(/(\d+(\.\d+)?)\s*k/i); // Matches "5k", "10.5km", etc.
        const distance = distanceMatch ? parseFloat(distanceMatch[1]) : null;

        if (distance) {
          const token = localStorage.getItem('authToken');
          if (token) {
            await fetch('http://localhost:3000/api/activities', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
              body: JSON.stringify({ type: 'run', distance: distance })
            });
            console.log(`Logged a run of ${distance}km to the backend.`);
          }
        }
      }


      // --- NEW: Parse AI response for preference changes and persist them ---
      const lowerCaseAiResponse = responseText.toLowerCase();

      if (lowerCaseAiResponse.includes('your preferred time has been updated to:')) {
          const timeMatch = lowerCaseAiResponse.match(/updated to:\s*(morning|evening)/);
          if (timeMatch && timeMatch[1]) { prefs.time = timeMatch[1]; preferencesChanged = true; }
      }

      if (lowerCaseAiResponse.includes('new interests:')) {
          const interestsMatch = lowerCaseAiResponse.match(/new interests:\s*(.*)/);
          if (interestsMatch && interestsMatch[1]) {
              const newInterestsArray = interestsMatch[1].split(',').map(s => s.trim()).filter(Boolean);
              prefs.interests = new Set(newInterestsArray);
              preferencesChanged = true;
          }
      }

      if (preferencesChanged) {
        renderRecs(); // Re-render recommendations immediately
        // Persist the changes to the backend
        const token = localStorage.getItem('authToken');
        await fetch('http://localhost:3000/api/preferences', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
            body: JSON.stringify({ interests: Array.from(prefs.interests), time: prefs.time })
        });
        console.log("Preferences saved to backend.");
      }
      input.disabled = false; // Re-enable input
      sendBtn.disabled = false;
      input.focus();
    }
    // Enter key
    input.addEventListener('keydown', e=>{ if(e.key==='Enter'){ send(); } });

    // --------------------------
    // YOUTUBE BACKGROUND HELPERS
    // Ensures the video covers and remains muted/looped. If a browser blocks autoplay, user interaction (scroll/click) will start it.
    // This uses the official YouTube IFrame Player API for better reliability.
    // --------------------------
    const VIDEO_ID = (document.documentElement.getAttribute('data-video-id') || 'VIDEO_ID_HERE').trim();
    let player;

    // This function is called by the YouTube API script once it's ready.
    function onYouTubeIframeAPIReady() {
      if (VIDEO_ID && VIDEO_ID !== 'VIDEO_ID_HERE') {
        player = new YT.Player('ytbg', {
          videoId: VIDEO_ID,
          playerVars: {
            'autoplay': 1,
            'controls': 0,
            'showinfo': 0,
            'modestbranding': 1,
            'loop': 1,
            'playsinline': 1,
            'rel': 0,
            'playlist': VIDEO_ID // Required for loop to work
          },
          events: {
            'onReady': onPlayerReady
          }
        });
      }
    }

    function onPlayerReady(event) {
      event.target.mute();
      event.target.playVideo();
    }
  </script>
</body>
</html>